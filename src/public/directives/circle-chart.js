(function(){
    
  function CircleChart(options){
    return {
      aspectRatio : 1,
      center      : true,
      map:function(){
        return {"name":"IIB","children":[{"id":"5567248fe5f596646ed63d51","type":"inode","name":"Broker8","size":129,"children":[{"id":"eg70","type":"iserver","name":"eg1","isRunning":true,"size":4986,"children":[{"id":"flow986","type":"messageflow","name":"HTTPInOut6","isRunning":true,"size":175},{"id":"flow962","type":"messageflow","name":"HTTPInOut5","isRunning":true,"size":2587},{"id":"flow931","type":"messageflow","name":"HTTPInOut7","isRunning":true,"size":4390},{"id":"flow866","type":"messageflow","name":"HTTPInOut8","isRunning":true,"size":4404},{"id":"application340","type":"application","name":"SimpleHTTPINOUT","isRunning":true,"size":2031,"children":[{"id":"flow968","type":"applicationflow","name":"HTTPInOut2","isRunning":true,"size":5095},{"id":"flow512","type":"applicationflow","name":"HTTPInOut","isRunning":true,"size":4522}]},{"id":"application884","type":"application","name":"SimpleHTTPInOut2","isRunning":true,"size":212,"children":[{"id":"flow654","type":"applicationflow","name":"HTTPInOut4","isRunning":true,"size":1821},{"id":"flow223","type":"applicationflow","name":"HTTPInOut3","isRunning":true,"size":1838}]}]},{"id":"eg999","type":"iserver","name":"eg2","isRunning":true,"size":559,"children":[{"id":"flow774","type":"messageflow","name":"HTTPInOut6","isRunning":true,"size":2373},{"id":"flow872","type":"messageflow","name":"HTTPInOut5","isRunning":true,"size":4705},{"id":"flow486","type":"messageflow","name":"HTTPInOut7","isRunning":true,"size":191},{"id":"flow97","type":"messageflow","name":"HTTPInOut8","isRunning":true,"size":1871},{"id":"application116","type":"application","name":"SimpleHTTPINOUT","isRunning":true,"size":859,"children":[{"id":"flow563","type":"applicationflow","name":"HTTPInOut2","isRunning":true,"size":3519},{"id":"flow170","type":"applicationflow","name":"HTTPInOut","isRunning":true,"size":3458}]},{"id":"application328","type":"application","name":"SimpleHTTPInOut2","isRunning":true,"size":481,"children":[{"id":"flow584","type":"applicationflow","name":"HTTPInOut4","isRunning":true,"size":1521},{"id":"flow7","type":"applicationflow","name":"HTTPInOut3","isRunning":true,"size":3547}]}]},{"id":"eg694","type":"iserver","name":"eg3","isRunning":false,"size":2997,"children":[{"id":"flow772","type":"messageflow","name":"HTTPInOut6","isRunning":false,"size":2514},{"id":"flow532","type":"messageflow","name":"HTTPInOut5","isRunning":false,"size":1412},{"id":"flow66","type":"messageflow","name":"HTTPInOut7","isRunning":false,"size":2430},{"id":"flow49","type":"messageflow","name":"HTTPInOut8","isRunning":false,"size":1019},{"id":"application469","type":"application","name":"SimpleHTTPINOUT","isRunning":false,"size":2763,"children":[{"id":"flow884","type":"applicationflow","name":"HTTPInOut2","isRunning":false,"size":1959},{"id":"flow49","type":"applicationflow","name":"HTTPInOut","isRunning":false,"size":634}]},{"id":"application502","type":"application","name":"SimpleHTTPInOut2","isRunning":false,"size":1966,"children":[{"id":"flow874","type":"applicationflow","name":"HTTPInOut4","isRunning":false,"size":2677},{"id":"flow738","type":"applicationflow","name":"HTTPInOut3","isRunning":false,"size":2952}]}]},{"id":"eg930","type":"iserver","name":"eg4","isRunning":true,"size":617,"children":[{"id":"flow685","type":"messageflow","name":"HTTPInOut6","isRunning":true,"size":2438},{"id":"flow217","type":"messageflow","name":"HTTPInOut5","isRunning":true,"size":1682},{"id":"flow757","type":"messageflow","name":"HTTPInOut7","isRunning":true,"size":950},{"id":"flow28","type":"messageflow","name":"HTTPInOut8","isRunning":true,"size":2566},{"id":"application994","type":"application","name":"SimpleHTTPINOUT","isRunning":true,"size":716,"children":[{"id":"flow826","type":"applicationflow","name":"HTTPInOut2","isRunning":true,"size":2006},{"id":"flow534","type":"applicationflow","name":"HTTPInOut","isRunning":true,"size":495}]},{"id":"application875","type":"application","name":"SimpleHTTPInOut2","isRunning":true,"size":2617,"children":[{"id":"flow95","type":"applicationflow","name":"HTTPInOut4","isRunning":true,"size":4234},{"id":"flow417","type":"applicationflow","name":"HTTPInOut3","isRunning":true,"size":2836}]}]},{"id":"eg192","type":"iserver","name":"eg5","isRunning":true,"size":3708,"children":[{"id":"flow179","type":"messageflow","name":"HTTPInOut6","isRunning":true,"size":412},{"id":"flow394","type":"messageflow","name":"HTTPInOut5","isRunning":true,"size":2897},{"id":"flow151","type":"messageflow","name":"HTTPInOut7","isRunning":true,"size":2499},{"id":"flow851","type":"messageflow","name":"HTTPInOut8","isRunning":true,"size":1526},{"id":"application227","type":"application","name":"SimpleHTTPINOUT","isRunning":false,"size":863,"children":[{"id":"flow93","type":"applicationflow","name":"HTTPInOut2","isRunning":false,"size":3206},{"id":"flow909","type":"applicationflow","name":"HTTPInOut","isRunning":false,"size":972}]},{"id":"application93","type":"application","name":"SimpleHTTPInOut2","isRunning":false,"size":367,"children":[{"id":"flow559","type":"applicationflow","name":"HTTPInOut4","isRunning":false,"size":2130},{"id":"flow500","type":"applicationflow","name":"HTTPInOut3","isRunning":false,"size":3122}]}]}]},{"id":"5567247ae5f596646ed63d4f","type":"inode","name":"Broker12","size":4708,"children":[{"id":"eg750","type":"iserver","name":"eg1","isRunning":true,"size":140,"children":[{"id":"flow311","type":"messageflow","name":"HTTPInOut6","isRunning":true,"size":2954},{"id":"flow572","type":"messageflow","name":"HTTPInOut5","isRunning":true,"size":347},{"id":"flow943","type":"messageflow","name":"HTTPInOut7","isRunning":true,"size":1957},{"id":"flow725","type":"messageflow","name":"HTTPInOut8","isRunning":true,"size":4707},{"id":"application880","type":"application","name":"SimpleHTTPINOUT","isRunning":true,"size":969,"children":[{"id":"flow980","type":"applicationflow","name":"HTTPInOut2","isRunning":true,"size":134},{"id":"flow47","type":"applicationflow","name":"HTTPInOut","isRunning":true,"size":5068}]},{"id":"application573","type":"application","name":"SimpleHTTPInOut2","isRunning":true,"size":2265,"children":[{"id":"flow652","type":"applicationflow","name":"HTTPInOut4","isRunning":true,"size":917},{"id":"flow201","type":"applicationflow","name":"HTTPInOut3","isRunning":true,"size":126}]}]},{"id":"eg272","type":"iserver","name":"eg2","isRunning":false,"size":1164,"children":[{"id":"flow181","type":"messageflow","name":"HTTPInOut6","isRunning":false,"size":2130},{"id":"flow558","type":"messageflow","name":"HTTPInOut5","isRunning":false,"size":1710},{"id":"flow529","type":"messageflow","name":"HTTPInOut7","isRunning":false,"size":112},{"id":"flow178","type":"messageflow","name":"HTTPInOut8","isRunning":false,"size":4528},{"id":"application236","type":"application","name":"SimpleHTTPINOUT","isRunning":false,"size":236,"children":[{"id":"flow418","type":"applicationflow","name":"HTTPInOut2","isRunning":false,"size":2313},{"id":"flow641","type":"applicationflow","name":"HTTPInOut","isRunning":false,"size":1855}]},{"id":"application178","type":"application","name":"SimpleHTTPInOut2","isRunning":false,"size":1059,"children":[{"id":"flow375","type":"applicationflow","name":"HTTPInOut4","isRunning":false,"size":4504},{"id":"flow298","type":"applicationflow","name":"HTTPInOut3","isRunning":false,"size":846}]}]},{"id":"eg539","type":"iserver","name":"eg3","isRunning":true,"size":4225,"children":[{"id":"flow755","type":"messageflow","name":"HTTPInOut6","isRunning":true,"size":2072},{"id":"flow370","type":"messageflow","name":"HTTPInOut5","isRunning":true,"size":4646},{"id":"flow885","type":"messageflow","name":"HTTPInOut7","isRunning":true,"size":4362},{"id":"flow83","type":"messageflow","name":"HTTPInOut8","isRunning":true,"size":2910},{"id":"application837","type":"application","name":"SimpleHTTPINOUT","isRunning":true,"size":928,"children":[{"id":"flow170","type":"applicationflow","name":"HTTPInOut2","isRunning":true,"size":2762},{"id":"flow60","type":"applicationflow","name":"HTTPInOut","isRunning":true,"size":3926}]},{"id":"application608","type":"application","name":"SimpleHTTPInOut2","isRunning":true,"size":4265,"children":[{"id":"flow832","type":"applicationflow","name":"HTTPInOut4","isRunning":true,"size":2587},{"id":"flow964","type":"applicationflow","name":"HTTPInOut3","isRunning":true,"size":2860}]}]},{"id":"eg547","type":"iserver","name":"eg4","isRunning":true,"size":1230,"children":[{"id":"flow207","type":"messageflow","name":"HTTPInOut6","isRunning":true,"size":2151},{"id":"flow79","type":"messageflow","name":"HTTPInOut5","isRunning":true,"size":3106},{"id":"flow179","type":"messageflow","name":"HTTPInOut7","isRunning":true,"size":244},{"id":"flow540","type":"messageflow","name":"HTTPInOut8","isRunning":false,"size":251},{"id":"application243","type":"application","name":"SimpleHTTPINOUT","isRunning":false,"size":1143,"children":[{"id":"flow799","type":"applicationflow","name":"HTTPInOut2","isRunning":false,"size":982},{"id":"flow146","type":"applicationflow","name":"HTTPInOut","isRunning":false,"size":752}]},{"id":"application240","type":"application","name":"SimpleHTTPInOut2","isRunning":true,"size":4039,"children":[{"id":"flow84","type":"applicationflow","name":"HTTPInOut4","isRunning":true,"size":181},{"id":"flow368","type":"applicationflow","name":"HTTPInOut3","isRunning":true,"size":1824}]}]},{"id":"eg736","type":"iserver","name":"eg5","isRunning":true,"size":1385,"children":[{"id":"flow674","type":"messageflow","name":"HTTPInOut6","isRunning":true,"size":2090},{"id":"flow83","type":"messageflow","name":"HTTPInOut5","isRunning":true,"size":1257},{"id":"flow687","type":"messageflow","name":"HTTPInOut7","isRunning":true,"size":4550},{"id":"flow913","type":"messageflow","name":"HTTPInOut8","isRunning":true,"size":4997},{"id":"application184","type":"application","name":"SimpleHTTPINOUT","isRunning":true,"size":4945,"children":[{"id":"flow847","type":"applicationflow","name":"HTTPInOut2","isRunning":true,"size":3920},{"id":"flow848","type":"applicationflow","name":"HTTPInOut","isRunning":true,"size":1196}]},{"id":"application611","type":"application","name":"SimpleHTTPInOut2","isRunning":true,"size":1135,"children":[{"id":"flow416","type":"applicationflow","name":"HTTPInOut4","isRunning":true,"size":2373},{"id":"flow514","type":"applicationflow","name":"HTTPInOut3","isRunning":true,"size":2063}]}]}]},{"id":"55672486e5f596646ed63d50","type":"inode","name":"Broker4","size":831,"children":[{"id":"eg55","type":"iserver","name":"eg1","isRunning":true,"size":808,"children":[{"id":"flow268","type":"messageflow","name":"HTTPInOut6","isRunning":true,"size":3092},{"id":"flow862","type":"messageflow","name":"HTTPInOut5","isRunning":true,"size":3152},{"id":"flow834","type":"messageflow","name":"HTTPInOut7","isRunning":false,"size":1890},{"id":"flow909","type":"messageflow","name":"HTTPInOut8","isRunning":true,"size":4801},{"id":"application839","type":"application","name":"SimpleHTTPINOUT","isRunning":true,"size":1511,"children":[{"id":"flow738","type":"applicationflow","name":"HTTPInOut2","isRunning":true,"size":3136},{"id":"flow850","type":"applicationflow","name":"HTTPInOut","isRunning":true,"size":2949}]},{"id":"application157","type":"application","name":"SimpleHTTPInOut2","isRunning":true,"size":2493,"children":[{"id":"flow917","type":"applicationflow","name":"HTTPInOut4","isRunning":true,"size":876},{"id":"flow382","type":"applicationflow","name":"HTTPInOut3","isRunning":true,"size":4568}]}]},{"id":"eg210","type":"iserver","name":"eg2","isRunning":true,"size":672,"children":[{"id":"flow214","type":"messageflow","name":"HTTPInOut6","isRunning":true,"size":4255},{"id":"flow706","type":"messageflow","name":"HTTPInOut5","isRunning":true,"size":1465},{"id":"flow964","type":"messageflow","name":"HTTPInOut7","isRunning":true,"size":3525},{"id":"flow124","type":"messageflow","name":"HTTPInOut8","isRunning":true,"size":2066},{"id":"application97","type":"application","name":"SimpleHTTPINOUT","isRunning":true,"size":4618,"children":[{"id":"flow875","type":"applicationflow","name":"HTTPInOut2","isRunning":true,"size":4370},{"id":"flow56","type":"applicationflow","name":"HTTPInOut","isRunning":true,"size":2037}]},{"id":"application265","type":"application","name":"SimpleHTTPInOut2","isRunning":true,"size":1487,"children":[{"id":"flow957","type":"applicationflow","name":"HTTPInOut4","isRunning":false,"size":1633},{"id":"flow795","type":"applicationflow","name":"HTTPInOut3","isRunning":true,"size":4975}]}]},{"id":"eg340","type":"iserver","name":"eg3","isRunning":true,"size":3411,"children":[{"id":"flow387","type":"messageflow","name":"HTTPInOut6","isRunning":true,"size":3403},{"id":"flow6","type":"messageflow","name":"HTTPInOut5","isRunning":true,"size":4110},{"id":"flow94","type":"messageflow","name":"HTTPInOut7","isRunning":true,"size":2625},{"id":"flow551","type":"messageflow","name":"HTTPInOut8","isRunning":true,"size":2469},{"id":"application824","type":"application","name":"SimpleHTTPINOUT","isRunning":true,"size":3311,"children":[{"id":"flow8","type":"applicationflow","name":"HTTPInOut2","isRunning":true,"size":4703},{"id":"flow135","type":"applicationflow","name":"HTTPInOut","isRunning":true,"size":290}]},{"id":"application122","type":"application","name":"SimpleHTTPInOut2","isRunning":true,"size":492,"children":[{"id":"flow165","type":"applicationflow","name":"HTTPInOut4","isRunning":true,"size":2782},{"id":"flow690","type":"applicationflow","name":"HTTPInOut3","isRunning":true,"size":1506}]}]},{"id":"eg224","type":"iserver","name":"eg4","isRunning":true,"size":854,"children":[{"id":"flow609","type":"messageflow","name":"HTTPInOut6","isRunning":true,"size":849},{"id":"flow824","type":"messageflow","name":"HTTPInOut5","isRunning":true,"size":3247},{"id":"flow957","type":"messageflow","name":"HTTPInOut7","isRunning":true,"size":4952},{"id":"flow854","type":"messageflow","name":"HTTPInOut8","isRunning":true,"size":2106},{"id":"application777","type":"application","name":"SimpleHTTPINOUT","isRunning":true,"size":1560,"children":[{"id":"flow328","type":"applicationflow","name":"HTTPInOut2","isRunning":true,"size":1320},{"id":"flow485","type":"applicationflow","name":"HTTPInOut","isRunning":true,"size":1284}]},{"id":"application552","type":"application","name":"SimpleHTTPInOut2","isRunning":true,"size":2244,"children":[{"id":"flow667","type":"applicationflow","name":"HTTPInOut4","isRunning":true,"size":1021},{"id":"flow333","type":"applicationflow","name":"HTTPInOut3","isRunning":true,"size":1282}]}]},{"id":"eg5","type":"iserver","name":"eg5","isRunning":false,"size":4724,"children":[{"id":"flow487","type":"messageflow","name":"HTTPInOut6","isRunning":false,"size":2596},{"id":"flow48","type":"messageflow","name":"HTTPInOut5","isRunning":false,"size":2660},{"id":"flow239","type":"messageflow","name":"HTTPInOut7","isRunning":false,"size":2640},{"id":"flow53","type":"messageflow","name":"HTTPInOut8","isRunning":false,"size":318},{"id":"application800","type":"application","name":"SimpleHTTPINOUT","isRunning":false,"size":1303,"children":[{"id":"flow951","type":"applicationflow","name":"HTTPInOut2","isRunning":false,"size":3921},{"id":"flow687","type":"applicationflow","name":"HTTPInOut","isRunning":false,"size":2530}]},{"id":"application409","type":"application","name":"SimpleHTTPInOut2","isRunning":false,"size":1588,"children":[{"id":"flow345","type":"applicationflow","name":"HTTPInOut4","isRunning":false,"size":1722},{"id":"flow130","type":"applicationflow","name":"HTTPInOut3","isRunning":false,"size":377}]}]}]}]};
      },
      init:function (canvas,data){
        this.color = d3.scale.linear()
            .domain([-1, 3])
            .range(["hsl(152,80%,0%)", "hsl(228,30%,70%)"])
            .interpolate(d3.interpolateHcl);

        this.pack = d3.layout.pack()
            .padding(2)
            .size([canvas.width, canvas.height])
            .value(function(d) {
                return d.size;
            });
        
        //TODO should this really be done in css or set by the containing app?
        canvas.svg.style("border-radius","50px");
        this.svg = canvas.svg.append("g")
                    .attr("id", "circle");
                    
        
                    
      },
      draw: function (canvas,root){
        var self=this;
        var focus = root,
                nodes = this.pack.nodes(root),
                view;
        var circle = this.svg.selectAll("circle")
            .data(nodes)
            .enter().append("circle")
            .attr("class", function(d) {
                return d.parent ? d.children ? "node" : "node node--leaf" : "node node--root";
            })
            .attr("id", function(d) {
                return d.id;
            })
            .attr("value", function(d) {
                return d.name
            })
            .attr("parent", function(d) {
                if (d.parent) return d.parent['id']
            })

            .style({
                "fill": function(d) {
                    if (d.type == 'messageflow') {
                        if (!d.isRunning)
                            return "#ffd6d6";
                        return 'white';
                    } else if (d.type == 'applicationflow') {
                        if (!d.isRunning)
                            return "#ff9307";
                        return 'yellow';
                    } else {
                        return self.color(d.depth);
                    }
                    //return ((d.type != 'messageflow') || (d.type != 'applicationflow')) ? color(d.depth) : 'white' : 'yellow';
                },
                "display": "inline-block"
            })
            .on("click", function(d) {
                // check the type of the clicked element and call the getResources() method inside the chart controller
                //TODO emit events from this widget and handle them in the containing app's controller
                /*if (d.type == "inode") {
                    chartCtrl.getResources(d.id, null, null, null, d.type, d.name);
                } else if (d.type == "iserver") {
                    chartCtrl.getResources(d.parent.id, d.name, null, null, d.type, d.name);
                } else if (d.type == "messageflow") {
                    chartCtrl.getResources(d.parent.parent.id, d.parent.name, null, d.name, d.type, d.name);
                } else  if (d.type == "application") {
                    chartCtrl.getResources(d.parent.parent.id, d.parent.name, d.name, null, d.type, d.name);
                } else if (d.type == "applicationflow") {
                    chartCtrl.getResources(d.parent.parent.parent.id, d.parent.parent.name, d.parent.name, d.name, d.type, d.name);
                }*/
                if (focus !== d) zoom(d), d3.event.stopPropagation();
            });
            
            var text = this.svg.selectAll("text")
                .data(nodes)
                .enter().append("text")
                .attr("class", "label")
                .style("fill-opacity", function(d) {
                    return d.parent === root ? 1 : 0;
                })
                .style("display", function(d) {
                    return d.parent === root ? null : "none";
                })
                //.style("display", function(d) { if (d.attr('class')) })
                .text(function(d) {
                    return d.name;
                });
                
            var node = this.svg.selectAll("circle,text");

            this.svg 
                .style("background", self.color(-1))
                .on("click", function() {
                    zoom(root);
                });

            zoomTo([root.x, root.y, root.r * 2 ]);
            
            function zoom(d) {
                var focus0 = focus;
                focus = d;

                var transition = d3.transition()
                    .duration(d3.event.altKey ? 7500 : 750)
                    .tween("zoom", function(d) {
                        var i = d3.interpolateZoom(view, [focus.x, focus.y, focus.r * 2]);
                        return function(t) {
                            zoomTo(i(t));
                        };
                    });

                transition.selectAll("text")
                    .filter(function(d) {
                        return d.parent === focus || this.style.display === "inline";
                    })
                    .style("fill-opacity", function(d) {
                        return d.parent === focus ? 1 : 0;
                    })
                    .each("start", function(d) {
                        if (d.parent === focus) this.style.display = "inline";
                    })
                    .each("end", function(d) {
                        if (d.parent !== focus) this.style.display = "none";
                    });
            }
            
            function zoomTo(v) {
                var k = canvas.width / v[2];
                view = v;
                node.attr("transform", function(d) {
                    return "translate(" + (d.x - v[0]) * k + "," + (d.y - v[1]) * k + ")";
                });
                circle.attr("r", function(d) {
                    return d.r * k;
                }).attr("z-index", "-1");
            }            
      }
    }     
  };
  var circleChartWidget = {
    widget     : CircleChart,//widget constructor
    descriptor : {
      id          : "iib-circle-chart",
      name        : "Heat map",
      description : "Integration bus, nodes, servers, applications etc laid out as a circle pack",
      preview     : "images/circlePack.png",
      attributes  : [ ]
    }
  };
  
  function iibCircleChartDirective($rootScope,d3Util,iibWidgetRegistry){
    return {
      restrict: 'A',
      scope:{        
      },
      link: link
    };

    function link(scope,iElement,iAttrs){
      var widget=iibWidgetRegistry.createWidget("iib-circle-chart",scope);
      
      d3Util.renderWidget(widget,iElement);      
    }    
  }
  
  angular.module('iibWidgets')
  .config(function(iibWidgetRegistryProvider){
    iibWidgetRegistryProvider.register(circleChartWidget);
    
  })
  .directive('iibCircleChart', ['$rootScope', 'd3Util','iibWidgetRegistry',iibCircleChartDirective])
  ;
})();

